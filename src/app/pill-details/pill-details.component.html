<div class="connection-status" [class.online]="isOnline" [class.offline]="!isOnline">
  <span *ngIf="isOnline">🟢 متصل بالإنترنت</span>
  <span *ngIf="!isOnline">🔴 غير متصل - عرض البيانات المخزنة محلياً</span>
  <span *ngIf="usingOfflineData && !isOnline"> (بيانات مخزنة محلياً)</span>
</div>

<style>
.connection-status {
  padding: 8px;
  margin: 10px 0;
  border-radius: 4px;
  text-align: center;
  font-weight: bold;
}

.connection-status.online {
  background-color: #d4edda;
  color: #155724;
  border: 1px solid #c3e6cb;
}

.connection-status.offline {
  background-color: #f8d7da;
  color: #721c24;
  border: 1px solid #f5c6cb;
}
</style>
<div class="p-3" appShowLoaderUntilPageLoaded [isReady]="loading">
  <!-- Offline Indicator -->
  <div *ngIf="usingOfflineData" class="alert alert-warning mb-3">
    <i class="fas fa-wifi-slash me-2"></i>
    أنت تشاهد بيانات غير متصلة بالإنترنت. قد تكون بعض المعلومات غير محدثة.
  </div>

  <nav class="inner-header">
    <nav style="--bs-breadcrumb-divider: '>'" aria-label="breadcrumb">
      <ol class="breadcrumb">
        <li class="breadcrumb-item">الفواتير</li>
        <li class="breadcrumb-item active" aria-current="page">فاتورة</li>
      </ol>
    </nav>
  </nav>
  
  <div class="d-flex gap-1 mb-3">
    <!-- Print Button -->
    <button pButton type="button" label="طباعة الفاتورة" icon="pi pi-print" 
            (click)="onPrintButtonClick()" [disabled]="isPrinting" 
            class="fs-6 rounded-4">
      <span *ngIf="isPrinting">
        <i class="pi pi-spinner pi-spin me-2"></i>
        جاري الطباعة...
      </span>
      <span *ngIf="!isPrinting">
        <i class="pi pi-print me-2"></i>
        طباعة الفاتورة
      </span>
    </button>

    <!-- Refresh Button for Offline Mode -->
    <button *ngIf="usingOfflineData && isOnline" pButton type="button" 
            label="تحديث البيانات" icon="pi pi-refresh" 
            (click)="fetchPillsDetails(pillId)" 
            class="fs-6 rounded-4 p-button-secondary">
    </button>
  </div>

  <!-- Data Not Found Message -->
  <div *ngIf="!pillDetails && loading" class="alert alert-info">
    <i class="fas fa-info-circle me-2"></i>
    لم يتم العثور على بيانات الفاتورة.
  </div>

  <div #printedPill class="printed-pill" *ngIf="pillDetails">
    <!-- Branch Information -->
    <div class="card px-4 py-2 my-2" *ngFor="let item of branchDetails">
      <div class="card-img">
        <img src="assets/images/logo-with-white-bg.png" alt="Placeholder Logo" />
      </div>
      <h5>
        <i class="fas fa-file-alt main-color fs-4 ps-2"></i>معلومات الفرع
      </h5>

      <!-- Delivery Status -->
      <p class="fw-bold" *ngIf="invoices && invoices.length > 0 && invoices[0].order_type === 'Delivery' && isShow">
        حالة الطلب :
        <small class="btn-static-warning badge text-dark">
          <i class="fa-solid fa-location-dot ms-1"></i>
          {{ getTrackingStatusTranslation(trackingStatus) }}
        </small>
      </p>

      <p>
        <span class="fw-bold">عنوان الفرع :</span> {{ item.branch_address || 'غير متوفر' }}
      </p>
      <div class="d-flex gap-5">
        <p><span class="fw-bold">التاريخ :</span> {{ date || 'غير متوفر' }}</p>
        <p><span class="fw-bold">الساعة :</span> {{ time || 'غير متوفر' }}</p>
      </div>

      <p>
        <span class="fw-bold">رقم الإيصال :</span> {{ item.invoice_number || 'غير متوفر' }}
      </p>
      <p><span class="fw-bold">رقم الطلب :</span> {{ item.order_number || 'غير متوفر' }}</p>
      <p *ngIf="invoices && invoices.length > 0 && invoices[0].order_type === 'dine-in'">
        <span class="fw-bold">رقم الطاولة :</span> {{ item.table_number || 'غير متوفر' }}
      </p>
      <p>
        <span class="fw-bold">رقم التليفون :</span> {{ item.branch_phone || 'غير متوفر' }}
      </p>
    </div>

    <!-- Delivery Information -->
    <div class="card px-4 py-2 my-2" *ngIf="invoices && invoices.length > 0 && invoices[0].order_type === 'Delivery'">
      <h5>
        <i class="fas fa-file-alt main-color fs-4 ps-2"></i>معلومات التوصيل
      </h5>

      <p *ngIf="addresDetails?.client_name">
        <span class="fw-bold">الاسم :</span>
        {{ addresDetails.client_name }}
      </p>
      <p *ngIf="addresDetails?.client_address || addresDetails?.branch_name">
        <span class="fw-bold">العنوان :</span>
        {{ addresDetails.client_address || "غير متوفر" }}
        <span *ngIf="addresDetails.branch_name">, {{ addresDetails.branch_name}}</span>
      </p>

      <p *ngIf="addresDetails?.address_phone">
        <span class="fw-bold">رقم الهاتف :</span>
        {{ addresDetails.address_phone}}
      </p>
      <p *ngIf="invoices[0]?.delivery_name">
        <span class="fw-bold">اسم الطيار :</span>
        {{ invoices[0].delivery_name }}
      </p>
    </div>

    <!-- Order Details -->
    <div class="card p-2 my-2" *ngIf="orderDetails && orderDetails[0]?.length > 0">
      <div class="accordion accordion-flush" id="accordionFlushExample">
        <div class="accordion-item">
          <h2 class="accordion-header" id="flush-headingOne">
            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
              data-bs-target="#flush-collapseOne" aria-expanded="false" aria-controls="flush-collapseOne">
              <h5>
                <i class="fas fa-file-alt main-color fs-4 ps-2"></i> تفاصيل الطلب
              </h5>
            </button>
          </h2>
          <div id="flush-collapseOne" class="accordion-collapse collapse show" aria-labelledby="flush-headingOne"
            data-bs-parent="#accordionFlushExample">
            <div class="accordion-body">
              <div *ngFor="let item of orderDetails[0]"
                class="d-flex justify-content-between px-1 mb-1 align-items-start">
                <div class="d-flex flex-column">
                  <h6>
                    <span class="badge bg-lightgray text-dark ms-2">
                      {{ item.quantity }}
                    </span>
                    x
                    <span> {{ item.dish_name }} </span>
                  </h6>
                  <h6 class="text-muted mx-5 fw-medium" *ngIf="item.size">
                    الحجم: {{ item.size }}
                  </h6>
                  <h6 class="text-muted mx-5 fw-medium" *ngIf="item.addons?.length > 0"> 
                    الاضافات :
                    <span *ngFor="let addon of item.addons; let last = last">
                      {{ addon.addon_name }}<span *ngIf="!last">، </span>
                    </span>
                  </h6>
                  <h6 class="text-muted mx-5 fw-medium" *ngIf="item.note">
                    ملاحظات: {{ item.note }}
                  </h6>
                </div>
                <h6 class="fw-bold">
                  <span>{{ item.total_dish_price }} {{ invoiceSummary[0]?.currency_symbol || currencySymbol }}</span>
                </h6>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Payment Information -->
    <div class="card px-4 py-2 my-2" *ngIf="invoices && invoices.length > 0">
      <h5><i class="fas fa-file-alt main-color fs-4 ps-2"></i>معلومات الدفع</h5>

      <div class="d-flex justify-content-between align-items-center py-3">
        <h5 class="mb-0" *ngIf="invoices[0].transactions?.length == 1">
          <span class="badge bg-success text-white">
            الدفع :
            {{
            invoices[0]?.transactions[0].payment_method === "credit"
            ? "أونلاين"
            : "كاش"
            }}
          </span>
        </h5>

        <div class="d-flex align-items-center">
          <p *ngIf="paymentStatus" class="mb-0 fw-bold">
            {{ paymentStatus === "paid" ? "مدفوعة" : "غير مدفوعة" }}
          </p>
        </div>
      </div>

      <!-- Multiple Transactions -->
      <div *ngIf="invoices[0]?.transactions?.length > 1">
        <div *ngFor="let inv of invoices[0].transactions">
          <div class="d-flex justify-content-between align-items-center my-1 fw-bold"
            *ngIf="inv.payment_status == 'paid'">
            <div>
              {{ inv.payment_method === "cash" ? " الكاش" : " الفيزا" }}
            </div>
            <div>{{ inv.paid }} {{ invoices[0].currency_symbol }}</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Invoice Summary -->
    <div class="card px-4 py-2 my-2" *ngFor="let item of invoiceSummary">
      <h5><i class="fas fa-file-alt main-color fs-4 ps-2"></i> الفاتورة</h5>
      
      <div class="d-flex justify-content-between px-2 mb-1">
        <h6>مجموع الطلب</h6>
        <h6>
          <span>{{ item.subtotal_price }} {{ item.currency_symbol }}</span>
        </h6>
      </div>

      <!-- Coupon Discount -->
      <div class="d-flex justify-content-between px-2 mb-1 main-color" 
           *ngIf="item.coupon_value && item.coupon_value !== '0.00' && item.coupon_value !== 0">
        <h6>كوبون خصم
          <span class="btn-static-secondary p-1 rounded">{{ item.coupon_title }} </span>
        </h6>
        <h6>
          -
          <span>{{ item.coupon_value }} {{ item.currency_symbol }}</span>
        </h6>
      </div>

      <!-- Service Fees -->
      <div class="d-flex justify-content-between px-2 mb-1" *ngIf="item.service_fees">
        <h6>
          رسوم الخدمة
          <span class="main-color" *ngIf="item.service_percentage">
            بنسبة {{ item.service_percentage }} %
          </span>
        </h6>
        <h6>
          <span>{{ item.service_fees }} {{ item.currency_symbol }}</span>
        </h6>
      </div>

      <!-- Delivery Fees -->
      <div class="d-flex justify-content-between px-2 mb-1" *ngIf="item.delivery_fees">
        <h6>رسوم التوصيل</h6>
        <h6>
          <span>{{ item.delivery_fees }} {{ item.currency_symbol }}</span>
        </h6>
      </div>

      <!-- Tax Information -->
      <div class="px-2 mb-1" *ngIf="!item.tax_application">
        <h6>
          تضاف ضريبة القيمة المضافة
          <span class="main-color"> بنسبة {{ item.tax_percentage }}% </span>
          بمعنى اخر {{ item.tax_value }} {{ item.currency_symbol }}
        </h6>
      </div>

      <div class="d-flex flex-column">
        <div class="px-2 mb-1" *ngIf="item.tax_application">
          <h6>سعر الوجبات يشتمل على ضريبة القيمة المضافة</h6>
        </div>

        <hr />

        <!-- Total Price -->
        <div class="d-flex justify-content-between px-2 mb-1">
          <h4 class="mb-0" style="font-weight: bold !important">
            المجموع الكلى
          </h4>
          <h6 class="fw-bold mb-0">
            <span>{{ item.total_price }} {{ item.currency_symbol }}</span>
          </h6>
        </div>
      </div>

      <div class="text-center mb-1">
        <h5>شكرا لك علي وقتك وثقتك بنا</h5>
      </div>
    </div>
  </div>
</div>

<!-- Hidden Printable Section -->
<div id="printSection" class="d-none printSection p-0">
  <!-- ... (your existing print section remains the same) ... -->
</div>

<app-confirm-dialog #confirmPrintDialog (actionResult)="printInvoice($event)" [header]="'تأكيد'"
  message='هل هذه الطباعة النهائية؟' [acceptLabel]="'نعم'" [rejectLabel]="'لا'"></app-confirm-dialog>